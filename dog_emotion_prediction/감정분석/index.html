<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pupilot - ì‹¤ì‹œê°„ ê°•ì•„ì§€ ìƒíƒœ (ë‹¨ì¼ í˜ì´ì§€)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5; margin: 0; padding: 1rem; display: flex; justify-content: center;
    }
    .container { width: 100%; max-width: 420px; }
    .header { background-color: #5CBDBD; padding: 1.5rem; border-radius: 1rem; color: white; text-align: center; margin-bottom: 1rem; }
    .video-section { background: white; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1rem; }
    .report-title { font-size: 1.125rem; font-weight: bold; color: #374151; margin-bottom: 1rem; display: flex; align-items: center; }
    .report-title span { margin-right: .5rem; }
    .video-container { position: relative; background: black; border-radius: 0.75rem; overflow: hidden; margin-bottom: .75rem; }
    .video-container video { width: 100%; height: 200px; display: block; }
    .controls { display: flex; gap: .5rem; margin: .5rem 0 1rem 0; }
    .btn { flex: 1; background: #5CBDBD; color: white; padding: .75rem 1rem; border: 0; border-radius: .75rem; font-weight: 600; cursor: pointer; }
    .btn.stop { background: #6b7280; }
    .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0; }
    .status-item { padding: 0.75rem; border-radius: 0.5rem; text-align: center; }
    .status-item.mood { background: #f0fdf4; }
    .status-item.activity { background: #eff6ff; }
    .status-item.health { background: #fefce8; }
    .status-emoji { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .status-label { font-size: 0.75rem; font-weight: 500; }
    .status-label.green { color: #16a34a; }
    .status-label.blue { color: #2563eb; }
    .status-label.yellow { color: #ca8a04; }
    .hidden { display: none; }
  </style>
  <!-- ONNX Runtime Web (WASM) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex; align-items:center; justify-content:center; gap:.5rem;">
        <span style="font-size:1.5rem;">ğŸ“¹</span><strong>ì‹¤ì‹œê°„ ê°•ì•„ì§€ ìƒíƒœ</strong>
      </div>
    </div>

    <div class="video-section">
      <div class="report-title"><span>ğŸ¬</span> ë¡œì»¬ ì˜ìƒ</div>

      <div class="video-container">
        <!-- ë¡œì»¬ ë™ì˜ìƒ ì„ë² ë“œ (ê°™ì€ í´ë”) -->
        <video id="videoEl" controls preload="metadata" playsinline>
          <source src="Screencast from 08-28-2025 01:18:23 AM.webm" type="video/webm">
          ì´ ë¸Œë¼ìš°ì €ëŠ” HTML5 ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </video>
      </div>

      <!-- ë¶„ì„ ì»¨íŠ¸ë¡¤ -->
      <div class="controls">
        <button id="btnStart" class="btn"  onclick="startAnalysis()">ë¶„ì„ ì‹œì‘</button>
        <button id="btnStop"  class="btn stop" onclick="stopAnalysis()" disabled>ë¶„ì„ ì¤‘ì§€</button>
      </div>

      <!-- ìƒíƒœ ë¼ë²¨ -->
      <div class="status-grid">
        <div class="status-item mood">
          <div class="status-emoji">ğŸ˜Š</div>
          <div class="status-label green"  id="moodLabel">ê¸°ë¶„ ì¢‹ìŒ</div>
        </div>
        <div class="status-item activity">
          <div class="status-emoji">ğŸƒ</div>
          <div class="status-label blue"   id="activityLabel">í™œë°œí•¨</div>
        </div>
        <div class="status-item health">
          <div class="status-emoji">â¤ï¸</div>
          <div class="status-label yellow" id="healthLabel">ê±´ê°•í•¨</div>
        </div>
      </div>
    </div>
  </div>

  <!-- í”„ë ˆì„ ì „ì²˜ë¦¬ìš© íˆë“  ìº”ë²„ìŠ¤ (ëª¨ë¸ ì…ë ¥ í¬ê¸°ë¡œ ìë™ ì¡°ì •) -->
  <canvas id="frameCanvas" class="hidden" width="224" height="224"></canvas>

  <script>
    // ==== ê²½ë¡œ/ì„¤ì • ====
    const MODEL_URL = 'dog_emotion_prior.onnx';  // ê°™ì€ í´ë”
    const SAMPLE_MS = 500;                       // ì¶”ë¡  ì£¼ê¸°(ms)

    // ==== ì „ì—­ ìƒíƒœ ====
    let session = null, timer = null, IN_W = 224, IN_H = 224;

    // ==== DOM ====
    const videoEl    = document.getElementById('videoEl');
    const moodEl     = document.getElementById('moodLabel');
    const activityEl = document.getElementById('activityLabel');
    const healthEl   = document.getElementById('healthLabel');
    const canvas     = document.getElementById('frameCanvas');
    const ctx        = canvas.getContext('2d');

    // ==== ëª¨ë¸ ë¡œë“œ ====
    async function loadModel() {
      // (CDN ì‚¬ìš© ì‹œ wasm íŒŒì¼ ê²½ë¡œ ì§€ì •í•´ë‘ë©´ ì•ˆì „)
      ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/';
      session = await ort.InferenceSession.create(MODEL_URL, {
        executionProviders: ['wasm'], graphOptimizationLevel: 'all'
      });

      // ì…ë ¥ í¬ê¸° ì¶”ì •í•´ì„œ ìº”ë²„ìŠ¤ ë§ì¶¤
      const inMeta = session.inputMetadata[session.inputNames[0]];
      const dims = inMeta?.dimensions || [1,3,224,224];
      IN_H = dims[dims.length - 2] > 0 ? dims[dims.length - 2] : 224;
      IN_W = dims[dims.length - 1] > 0 ? dims[dims.length - 1] : 224;
      canvas.width = IN_W; canvas.height = IN_H;
    }

    // ==== ì „ì²˜ë¦¬: video â†’ Float32 NCHW ====
    function preprocess() {
      ctx.drawImage(videoEl, 0, 0, IN_W, IN_H);
      const rgba = ctx.getImageData(0, 0, IN_W, IN_H).data;
      const plane = IN_W * IN_H;
      const chw = new Float32Array(3 * plane);
      let p = 0;
      for (let y = 0; y < IN_H; y++) {
        for (let x = 0; x < IN_W; x++) {
          const i = (y * IN_W + x) * 4;
          chw[p]          = rgba[i]   / 255; // R
          chw[p + plane]  = rgba[i+1] / 255; // G
          chw[p + 2*plane]= rgba[i+2] / 255; // B
          p++;
        }
      }
      const inputName = session.inputNames[0];
      return { [inputName]: new ort.Tensor('float32', chw, [1,3,IN_H,IN_W]) };
    }

    // ==== í›„ì²˜ë¦¬: ì˜ˆì‹œ ë§¤í•‘ (ëª¨ë¸ í´ë˜ìŠ¤ì— ë§ê²Œ ë°”ê¾¸ì„¸ìš”) ====
    function postprocess(outputs) {
      const out = outputs[session.outputNames[0]];
      const data = out.data;
      let best = 0, max = -Infinity;
      for (let i = 0; i < data.length; i++) if (data[i] > max) { max = data[i]; best = i; }

      // â†“â†“â†“ ì‹¤ì œ í´ë˜ìŠ¤ ìˆœì„œì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš” â†“â†“â†“
      const moodMap     = ['í™”ë‚¨', 'í–‰ë³µí•¨', 'í¸ì•ˆí•¨', 'ìŠ¬í””'];
      const activityMap = ['ë³´í†µ'];
      const healthMap   = ['ì–‘í˜¸'];

      moodEl.textContent     = moodMap[best % moodMap.length];
      activityEl.textContent = activityMap[(best+1) % activityMap.length];
      healthEl.textContent   = healthMap[(best+2) % healthMap.length];
    }

    // ==== ë£¨í”„ ====
    async function tick() {
      if (!session) return;
      if (videoEl.readyState < 2) return; // í”„ë ˆì„ ì¤€ë¹„ ì „
      const feeds = preprocess();
      const outputs = await session.run(feeds);
      postprocess(outputs);
    }

    // ==== ì‹œì‘/ì¤‘ì§€ ====
    async function startAnalysis() {
      if (!session) await loadModel();
      if (timer) return;
      timer = setInterval(tick, SAMPLE_MS);
      document.getElementById('btnStart').disabled = true;
      document.getElementById('btnStop').disabled = false;
    }
    function stopAnalysis() {
      if (timer) { clearInterval(timer); timer = null; }
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnStop').disabled = true;
    }

    // ì „ì—­ ë…¸ì¶œ (ë²„íŠ¼ì—ì„œ í˜¸ì¶œ)
    window.startAnalysis = startAnalysis;
    window.stopAnalysis  = stopAnalysis;
  </script>
</body>
</html>
