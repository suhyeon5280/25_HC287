<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pupilot - ì‚°ì±… ì¤‘</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    @keyframes pulse { 0%,100%{opacity:1;}50%{opacity:.5;} }
    @keyframes ping { 75%,100%{ transform:scale(2); opacity:0; } }
    .btn { @apply px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer; }
    .btn-primary { @apply bg-teal-400 hover:bg-teal-500 text-black; }
    .card { @apply bg-white rounded-lg shadow-sm border border-gray-200; }
    .input { @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400; }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=79380868f9e358ecd1118731747ff6a1&libraries=services,drawing"></script>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-md mx-auto bg-white min-h-screen">
    <div class="p-4 pb-20">
      <div class="space-y-6">
        <div class="bg-teal-400 rounded-2xl p-6 text-center">
          <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/pupilot-logo-9jkjboTGvHXXxkQFDbjqxEAdNTI4e0.png" alt="Pupilot" class="h-12 mx-auto mb-4" />
          <div id="destinationName" class="w-full bg-white text-black rounded-full py-3 font-medium">
            ëª©ì ì§€: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>

        <div class="card p-4">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-lg">ğŸ—ºï¸</span>
            <h2 class="font-semibold">ì‹¤ì‹œê°„ ìœ„ì¹˜</h2>
          </div>
          <div id="map" class="w-full h-64 rounded-lg border"></div>
        </div>

        <div class="card p-4">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-lg">ğŸ“¹</span>
            <h2 class="font-semibold">ì‹¤ì‹œê°„ ë¡œë´‡ ì‹œì•¼</h2>
          </div>
          <img src="http://127.0.0.1:5001/emotion_with_video_feed" class="w-full h-64 rounded-lg" alt="ì‹¤ì‹œê°„ ë¡œë´‡ ì‹œì•¼" />
        </div>
        
        <div class="card bg-blue-50 border-blue-200 p-4">
          <div class="border-l-4 border-blue-400 pl-4">
            <p class="font-medium">ì‚°ì±… ì¤‘ì…ë‹ˆë‹¤ ğŸš¶â€â™‚ï¸</p>
            <p class="text-sm text-gray-600">ë„ì°©ì§€ê¹Œì§€ ê²½ë¡œê°€ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
        </div>

        <a href="/done_navigation.html" class="w-full bg-teal-400 hover:bg-teal-500 text-black rounded-full py-3 font-medium text-center block">
          ì‚°ì±…ì¢…ë£Œ
        </a>
      </div>
    </div>
  </div>

  <script>
    let destination = null;
    try {
      destination = JSON.parse(localStorage.getItem("destination"));
    } catch (e) {
      console.error("destination ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
    }

    const destNameEl = document.getElementById("destinationName");
    if (destination && destination.name) {
      destNameEl.textContent = `ëª©ì ì§€: ${destination.name}`;
    } else {
      destNameEl.textContent = "ëª©ì ì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    }

    // âœ… ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ë° ê¸¸ì°¾ê¸° API ì—°ë™
    async function initMap() {
      if (!destination || !destination.lat || !destination.lng) {
        console.error("ëª©ì ì§€ ì •ë³´ ì—†ìŒ");
        return;
      }
      
      const mapContainer = document.getElementById('map');
      const mapOption = {
        center: new kakao.maps.LatLng(destination.lat, destination.lng),
        level: 5
      };
      const map = new kakao.maps.Map(mapContainer, mapOption);

      // ì¶œë°œì§€ ë§ˆì»¤
      const startPos = new kakao.maps.LatLng(37.631943, 127.076886);
      const startMarker = new kakao.maps.Marker({
        map: map,
        position: startPos,
        title: "ì„œìš¸ê³¼í•™ê¸°ìˆ ëŒ€í•™êµ"
      });

      // ëª©ì ì§€ ë§ˆì»¤
      const destPos = new kakao.maps.LatLng(destination.lat, destination.lng);
      const destMarker = new kakao.maps.Marker({
        map: map,
        position: destPos,
        title: destination.name
      });
      
      try {
        // âœ… Flask ì„œë²„ì˜ ê¸¸ì°¾ê¸° ë¼ìš°íŠ¸ í˜¸ì¶œ
        const res = await fetch(`/route?end_x=${destination.lng}&end_y=${destination.lat}`);
        if (!res.ok) throw new Error('ì„œë²„ ê¸¸ì°¾ê¸° ì˜¤ë¥˜');
        const data = await res.json();
        
        // ê²½ë¡œ ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ì§€ë„ì— í‘œì‹œ
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const lines = [];
          route.sections.forEach(section => {
            section.roads.forEach(road => {
              for (let i = 0; i < road.vertexes.length; i += 2) {
                const lng = road.vertexes[i];
                const lat = road.vertexes[i+1];
                lines.push(new kakao.maps.LatLng(lat, lng));
              }
            });
          });

          const polyline = new kakao.maps.Polyline({
            path: lines,
            strokeWeight: 5,
            strokeColor: '#00BFFF',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
          });
          polyline.setMap(map);

          // ê²½ë¡œ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
          const bounds = new kakao.maps.LatLngBounds();
          lines.forEach(point => bounds.extend(point));
          map.setBounds(bounds);
        } else {
          console.error("ê¸¸ì°¾ê¸° ê²½ë¡œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
      } catch (err) {
        console.error("ê¸¸ì°¾ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", err);
      }
    }

    kakao.maps.load(initMap);
  </script>
</body>
</html>